#!/usr/bin/env bash
set -euo pipefail

# Add SSH public key for remote access
# https://github.com/basecamp/omaterm

if [[ -f "$HOME/.ssh/authorized_keys" ]] && grep -q "^" "$HOME/.ssh/authorized_keys" 2>/dev/null; then
  echo "SSH authorized_keys exists. Use omaterm-add-ssh-key to add more."
  exit 0
fi

if gum confirm "Add SSH public key for remote access?"; then
  mkdir -p "$HOME/.ssh"
  chmod 700 "$HOME/.ssh"

  SSH_KEY=$(gum input --placeholder "ssh-ed25519 AAAAC3..." --prompt "SSH key: ")

  if [[ -z "$SSH_KEY" ]]; then
    echo "No key provided, skipping"
    exit 0
  fi

  echo "$SSH_KEY" >"$HOME/.ssh/authorized_keys"
  chmod 600 "$HOME/.ssh/authorized_keys"
  echo "SSH key added to authorized_keys"

  if gum confirm "Disable password authentication for SSH (key-based auth only)?"; then
    sudo sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
    sudo sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
    sudo systemctl restart sshd.service
    echo "SSH configured for key-based authentication only"
  fi
fi
